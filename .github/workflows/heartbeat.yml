# Token å¿ƒè·³ä¿æ´» - å®šæ—¶è§¦å‘å¿ƒè·³æ£€æµ‹ä¿æŒ Token æ´»è·ƒ
# é€‚ç”¨äºŽ Vercel Serverless éƒ¨ç½²åœºæ™¯
#
# ä½¿ç”¨å‰éœ€è¦åœ¨ä»“åº“ Settings > Secrets and variables > Actions ä¸­é…ç½®ï¼š
# - VERCEL_URL: ä½ çš„ Vercel éƒ¨ç½²åœ°å€ (å¦‚: https://your-app.vercel.app)
# - PPLX_ADMIN_TOKEN: ç®¡ç†å‘˜ Token (ä¸Ž Vercel çŽ¯å¢ƒå˜é‡ä¸­çš„ PPLX_ADMIN_TOKEN ä¸€è‡´)

name: Token Heartbeat

on:
  schedule:
    # æ¯ 4 å°æ—¶æ‰§è¡Œä¸€æ¬¡å¿ƒè·³æ£€æµ‹
    - cron: '0 */4 * * *'
  workflow_dispatch:
    # æ”¯æŒæ‰‹åŠ¨è§¦å‘
    inputs:
      test_single:
        description: 'æµ‹è¯•å•ä¸ª Token ID (ç•™ç©ºæµ‹è¯•å…¨éƒ¨)'
        required: false
        default: ''

jobs:
  heartbeat:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Check required secrets
        run: |
          if [ -z "${{ secrets.VERCEL_URL }}" ]; then
            echo "::error::Missing VERCEL_URL secret"
            exit 1
          fi
          if [ -z "${{ secrets.PPLX_ADMIN_TOKEN }}" ]; then
            echo "::error::Missing PPLX_ADMIN_TOKEN secret"
            exit 1
          fi
          echo "âœ… All required secrets are configured"

      - name: Health check
        run: |
          echo "ðŸ” Checking service health..."
          response=$(curl -s -w "\n%{http_code}" "${{ secrets.VERCEL_URL }}/health")
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)
          
          if [ "$http_code" != "200" ]; then
            echo "::error::Health check failed with status $http_code"
            echo "Response: $body"
            exit 1
          fi
          echo "âœ… Service is healthy"
          echo "$body" | jq . 2>/dev/null || echo "$body"

      - name: Trigger heartbeat test
        run: |
          echo "ðŸ’“ Triggering heartbeat test..."
          
          # æž„å»ºè¯·æ±‚ä½“
          if [ -n "${{ github.event.inputs.test_single }}" ]; then
            body='{"id": "${{ github.event.inputs.test_single }}"}'
            echo "Testing single token: ${{ github.event.inputs.test_single }}"
          else
            body='{}'
            echo "Testing all tokens"
          fi
          
          response=$(curl -s -w "\n%{http_code}" \
            -X POST "${{ secrets.VERCEL_URL }}/heartbeat/test" \
            -H "Content-Type: application/json" \
            -H "X-Admin-Token: ${{ secrets.PPLX_ADMIN_TOKEN }}" \
            -d "$body")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)
          
          echo "Response (HTTP $http_code):"
          echo "$body" | jq . 2>/dev/null || echo "$body"
          
          if [ "$http_code" != "200" ]; then
            echo "::warning::Heartbeat test returned status $http_code"
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å¤±è´¥çš„ token
          if echo "$body" | jq -e '.results | to_entries[] | select(.value.status == "error")' > /dev/null 2>&1; then
            echo "::warning::Some tokens failed the heartbeat test"
            echo "$body" | jq '.results | to_entries[] | select(.value.status == "error") | {id: .key, error: .value.error}'
          else
            echo "âœ… All tokens passed heartbeat test"
          fi

      - name: Summary
        run: |
          echo "## ðŸ’“ Heartbeat Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Service**: ${{ secrets.VERCEL_URL }}" >> $GITHUB_STEP_SUMMARY
